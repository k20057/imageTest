# ImageTest
## 主旨
從網路上下載圖片需要許多時間，每次重新執行都要重新下載，所以如果能夠把圖片儲存在快取，之後就不必重新下載，直接從快取讀取圖片，節省許多時間。
### 流程
整個流程是會先從記憶體快取讀取資料，沒有資料就從資料庫快取讀取資料，如果還是沒有資料就會從網路下載。下載完圖片會儲存到記憶體快取與資料庫快取。儲存到資料庫時會先將圖片等比例壓縮再儲存。
### 快取
快取分成記憶體快取與資料庫快取。記憶體快取有設儲存上限，超過會刪除最先儲存的快取。記憶體快取是定義一個陣列來儲存圖片，資料庫快取是使用SQLite。
### 下載
支援多任務下載，可設定同時能下載多少個，太多任務會造成網路阻塞，使用者會比較慢看到圖，畫面也容易卡頓，設2~4個任務較適當。
### 其它
讀取快取與下載圖片是在serial佇列執行。
下載完的圖片能夠刪除所有的快取，還有進到下一頁放大圖片與分享圖片。

## 過程
### 起因
做這個最主要的原因是想要有個作品，因此決定做非同步讀圖。並且不使用第三方套件，這非常有挑戰性。

### 規劃
#### 1 下載圖片
從最基本的做起，先照json結構建立model，之後把json轉成model object，解json得到下載的圖片的url，下載圖片放到cell之後，會因為cell重複利用，顯示錯誤的圖片，因為下載完圖片時cell可能已經變成另外一個位置的cell，解決的辦法是檢查下載完的圖片url與要顯示的url要一樣。
#### 2 下載與未下載
原本下載圖片是一次全部下載，非常慢又沒效率，在滑動UI時會非常卡頓，所以限制最多下載數量，超過會存在未下載，等正在下載完成後移除url，才會將未下載的url加到正在下載，並且移除未下載的url，直到兩個都為0。
#### 3 記憶體快取與資料庫快取，縮小圖片
先將圖片存在記憶體快取，但之後重新執行時還是會下載，原因是忘了寫return，如果找到圖就return，資料庫快取也是找到圖就return。
存到快取總共有三個欄位，分別是key，圖片，時間。
在存到快取時會將url轉成md5當成key，之後讀取圖片會先比對key，如果有找到key就代表有圖，之後就能傳回圖片。
存到資料庫快取的圖會先經過壓縮再儲存，之後讀取圖片顯示時會快許多，減少滑動UI卡頓的情形。

#### 4 用delegate傳圖到下一頁，scrollview放大圖片，刪除快取與分享圖片。
使用delegate將圖從cell傳到controller，方法是在cell放一個透明的button，之後再把圖傳到下一級的controller。
在controller右上角新增一個刪除button，能夠清空快取資料。
下一級的controller使用scrollview放大圖片，在右上角新增分享button。
#### 5 多執行緒與資料庫執行緒
讓快取與下載圖片都在privite執行緒執行，並且設定資料庫執行緒會serial執行，如果不設會有死鎖問題。
#### 6 重構、修改邏輯、checkNextDownload
增加註釋與讓程式更易讀，還有原本有些邏輯錯了，所以跑了許多不必要的步驟。
在記憶體快取與資料庫快取執行完之後加checkNextDownload，checkNextDownload是未下載url的function，目的是檢查還有沒有沒下載的url，因為讀到快取就不會跑到正在下載的function。
## 結論
花了一個月的時間，完成這個練習，學了許多技巧，了解cell的重用機制問題，快取，SQlite，物件獨立性，多執行緒，壓縮圖片，md5，程式重構，scrollView，分享。
